{% extends "base.html" %}

{% block title %}Attendance Reports - Labor Management System{% endblock %}
{% block page_title %}Attendance Reports{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: var(--space-xl);">
  <div class="card-header">
    <h2 class="card-title">Attendance Reports</h2>
    <p class="card-subtitle">View and analyze attendance data with flexible date ranges</p>
  </div>

  <!-- Filter Form -->
  <form method="GET" action="{{ url_for('reports.attendance_report') }}"
    style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-xl);">
    <div class="grid grid-cols-4">
      <div class="form-group" style="margin-bottom: 0;">
        <label for="period" class="form-label">Report Period</label>
        <select id="period" name="period" class="form-select" onchange="toggleCustomDates()">
          <option value="daily" {% if period=='daily' %}selected{% endif %}>Daily</option>
          <option value="weekly" {% if period=='weekly' %}selected{% endif %}>Weekly</option>
          <option value="monthly" {% if period=='monthly' %}selected{% endif %}>Monthly</option>
          <option value="custom" {% if period=='custom' %}selected{% endif %}>Custom Range</option>
        </select>
      </div>

      <div class="form-group" id="singleDateField" style="margin-bottom: 0;">
        <label for="date" class="form-label">Select Date</label>
        <input type="date" id="date" name="date" class="form-input"
          value="{{ start_date.strftime('%Y-%m-%d') if period != 'custom' else '' }}">
      </div>

      <div class="form-group" id="startDateField" style="margin-bottom: 0; display: none;">
        <label for="start_date" class="form-label">Start Date</label>
        <input type="date" id="start_date" name="start_date" class="form-input"
          value="{{ start_date.strftime('%Y-%m-%d') if period == 'custom' else '' }}">
      </div>

      <div class="form-group" id="endDateField" style="margin-bottom: 0; display: none;">
        <label for="end_date" class="form-label">End Date</label>
        <input type="date" id="end_date" name="end_date" class="form-input"
          value="{{ end_date.strftime('%Y-%m-%d') if period == 'custom' else '' }}">
      </div>

      <div style="display: flex; align-items: flex-end;">
        <button type="submit" class="btn btn-primary" style="width: 100%;">
          üìä Generate Report
        </button>
      </div>
    </div>
  </form>

  <!-- Summary Statistics -->
  <div class="grid grid-cols-4" style="margin-bottom: var(--space-xl);">
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Date Range</div>
        <div class="stat-card-icon primary">üìÖ</div>
      </div>
      <div
        style="font-size: var(--font-size-lg); font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-xs);">
        {{ start_date.strftime('%b %d') }} - {{ end_date.strftime('%b %d, %Y') }}
      </div>
      <div class="stat-card-change">{{ period|capitalize }} Report</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Total Records</div>
        <div class="stat-card-icon success">üìã</div>
      </div>
      <div class="stat-card-value">{{ records|length }}</div>
      <div class="stat-card-change">Attendance entries</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Total Wages</div>
        <div class="stat-card-icon warning">üí∞</div>
      </div>
      <div class="stat-card-value">‚Çπ{{ "%.2f"|format(total_wages) }}</div>
      <div class="stat-card-change">Sum of all wages</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-card-title">Average Wage</div>
        <div class="stat-card-icon primary">üìä</div>
      </div>
      <div class="stat-card-value">
        {% if records|length > 0 %}
        ‚Çπ{{ "%.2f"|format(total_wages / records|length) }}
        {% else %}
        ‚Çπ0.00
        {% endif %}
      </div>
      <div class="stat-card-change">Per attendance</div>
    </div>
  </div>

  <!-- Detailed Records -->
  {% if records %}
  <div style="margin-bottom: var(--space-lg); display: flex; justify-content: space-between; align-items: center;">
    <h3 style="font-size: var(--font-size-xl); color: var(--text-primary);">Detailed Records</h3>
    <button onclick="window.print()" class="btn btn-ghost">
      üñ®Ô∏è Print Report
    </button>
  </div>

  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Worker Name</th>
          <th>ID Number</th>
          <th>Labor Type</th>
          <th>Wage Amount</th>
          <th>Hours</th>
          <th>Tasks</th>
        </tr>
      </thead>
      <tbody>
        {% for record in records %}
        <tr>
          <td>{{ record.Attendance.work_date.strftime('%b %d, %Y') }}</td>
          <td>
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div
                style="width: 32px; height: 32px; border-radius: var(--radius-full); background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: var(--font-size-xs);">
                {{ record.Labor.name[0].upper() }}
              </div>
              <strong>{{ record.Labor.name }}</strong>
            </div>
          </td>
          <td>
            <code
              style="background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: var(--font-size-sm);">
                            {{ record.Labor.id_no }}
                        </code>
          </td>
          <td>
            <span class="badge 
                            {% if record.Attendance.labor_type == 'Daily' %}badge-primary
                            {% elif record.Attendance.labor_type == 'Hourly' %}badge-success
                            {% else %}badge-warning{% endif %}">
              {{ record.Attendance.labor_type }}
            </span>
          </td>
          <td><strong style="color: var(--color-success);">‚Çπ{{ "%.2f"|format(record.Attendance.wage_amount) }}</strong>
          </td>
          <td>
            {% if record.Attendance.hours_worked %}
            {{ record.Attendance.hours_worked }} hrs
            {% else %}
            <span style="color: var(--text-muted);">-</span>
            {% endif %}
          </td>
          <td>
            {% if record.Attendance.tasks_done %}
            {{ record.Attendance.tasks_done }}
            {% else %}
            <span style="color: var(--text-muted);">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">üìä</div>
    <div class="empty-state-title">No Records Found</div>
    <div class="empty-state-description">
      No attendance records found for the selected date range. Try adjusting your filters.
    </div>
    <a href="{{ url_for('admin.mark_attendance') }}" class="btn btn-primary" style="margin-top: var(--space-md);">
      ‚úì Mark Attendance
    </a>
  </div>
  {% endif %}
</div>

<script>
  // Toggle custom date fields based on period selection
  function toggleCustomDates() {
    const period = document.getElementById('period').value;
    const singleDateField = document.getElementById('singleDateField');
    const startDateField = document.getElementById('startDateField');
    const endDateField = document.getElementById('endDateField');

    if (period === 'custom') {
      singleDateField.style.display = 'none';
      startDateField.style.display = 'block';
      endDateField.style.display = 'block';
    } else {
      singleDateField.style.display = 'block';
      startDateField.style.display = 'none';
      endDateField.style.display = 'none';
    }
  }

  // Initialize on page load
  toggleCustomDates();
</script>

<style>
  @media print {

    .sidebar,
    .header,
    .mobile-menu-toggle,
    form,
    button {
      display: none !important;
    }

    .main-content {
      margin-left: 0 !important;
      margin-top: 0 !important;
    }

    .card {
      border: 1px solid #000;
      box-shadow: none;
    }
  }
</style>
{% endblock %}